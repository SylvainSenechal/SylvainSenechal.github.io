<div class="world"></div>
<div class="haiku">Shrouded in cloud, gods<br/>
Vent their anger, spewing out<br/>
Death and destruction
</div>
<div id="credits">
  <p> <a href="https://codepen.io/Yakudoo/"  target="blank">my other codepens</a> | <a href="https://www.epic.net" target="blank">epic.net</a></p>
</div>
<script src="three.min.js"></script>

<script>
class World {
  constructor(width, height) {

    this.renderer = new THREE.WebGLRenderer({
      alpha: true,
      antialias: true
    });
    this.renderer.setPixelRatio(window.devicePixelRatio);
    this.renderer.setSize(width, height);
    this.container = document.getElementsByClassName("world")[0];
    this.scene = new THREE.Scene();
    this.width = width;
    this.height = height;
    this.aspectRatio = width / height;
    this.fieldOfView = 50;
    var nearPlane = .1;
    var farPlane = 20000;
		this.targetRotX1 = Math.PI/3;
		this.targetRotX2 = -Math.PI/3;
		this.targetRotY1 = 0;
		this.targetRotY2 = 0;

    this.camera = new THREE.PerspectiveCamera(this.fieldOfView, this.aspectRatio, nearPlane, farPlane);
		this.camera.position.z = 250;
		this.container.appendChild(this.renderer.domElement);
    this.timer = 0;
    this.createPlanes();
		this.render();
  }

  createPlanes(){
    this.material = new THREE.RawShaderMaterial({
      vertexShader: document.getElementById( 'vertexShader' ).textContent,
      fragmentShader: document.getElementById('fragmentShader').textContent,

			uniforms: {
				u_time: { type: 'f', value: 5 },
				uHue: { type: 'f', value: .95 },
        u_resolution: { type: "v2", value: new THREE.Vector2() },
				u_mouse: {type: 'v2', value: new THREE.Vector2( 0.5, 0.5 ) }
    	}
    });

		this.material2 = this.material.clone();
		this.material2.uniforms.u_time.value = 5;
		this.material2.uniforms.uHue.value = .6;

    this.shapeGeometry = new  THREE.PlaneGeometry(200, 200, 256, 256);

    this.shape = new THREE.Mesh(this.shapeGeometry, this.material);
		this.shape.position.y = 50;
		this.shape.rotation.x = Math.PI/3;

		this.shape2 = new THREE.Mesh(this.shapeGeometry, this.material2);
		this.shape2.position.y = -50;
		this.shape2.rotation.x = -Math.PI/3;

		this.scene.add(this.shape);
		this.scene.add(this.shape2);
  }

  render() {
    this.timer+=.01;

		this.shape2.rotation.y += (this.targetRotY2 - this.shape2.rotation.y) * .05;
		this.shape2.rotation.x += (this.targetRotX2 - this.shape2.rotation.x) * .05;

		this.shape.rotation.y += (this.targetRotY1 - this.shape.rotation.y) * .05;
		this.shape.rotation.x += (this.targetRotX1 - this.shape.rotation.x) * .05;
  this.  shape.material.uniforms.u_resolution.value.x = this.renderer.domElement.width
    this.  shape2.material.uniforms.u_resolution.value.y = this.renderer.domElement.height
  this.    shape2.material.uniforms.u_resolution.value.x = this.renderer.domElement.width
    this.  shape.material.uniforms.u_resolution.value.y = this.renderer.domElement.height

		this.shape.material.uniforms.u_time.value = this.timer;
		this.shape2.material.uniforms.u_time.value = this.timer;
    this.renderer.render(this.scene, this.camera);
  }

  loop() {
    this.render();
		//this.shape.rotation.z += .005;
		requestAnimationFrame(this.loop.bind(this));
  }

  updateSize(w, h) {
    this.renderer.setSize(w, h);
    this.camera.aspect = w / h;
    this.camera.updateProjectionMatrix();
  }
  mouseMove(mousePos) {
		if (this.shape){
			this.shape.material.uniforms.u_mouse.value = new THREE.Vector2(mousePos.px, -mousePos.py);
			this.targetRotY1 = mousePos.px * .5;
			this.targetRotX1 = Math.PI/3 - mousePos.py * .3;

			this.shape2.material.uniforms.u_mouse.value = new THREE.Vector2(mousePos.px, mousePos.py);
			this.targetRotY2 = mousePos.px * .5;
			this.targetRotX2 = -Math.PI/3 - mousePos.py * .3;
		}
  }
};

document.addEventListener("DOMContentLoaded", domIsReady);
let mousePos = {x:0, y:0, px:0, py:0};
let PI = Math.PI;
let world;

function domIsReady() {
    world = new World(this.container, this.renderer, window.innerWidth, window.innerHeight);
    window.addEventListener('resize', handleWindowResize, false);
    document.addEventListener("mousemove", handleMouseMove, false);
    handleWindowResize();
    world.loop();
}

function handleWindowResize() {
    world.updateSize(window.innerWidth, window.innerHeight);
}

function handleMouseMove(e) {
    mousePos.x = e.clientX;
    mousePos.y = e.clientY;
    mousePos.px = mousePos.x / window.innerWidth * 2 - 1;
    mousePos.py = mousePos.y / window.innerHeight * 2 - 1;

    world.mouseMove(mousePos);
}
</script>

<script type="x-shader/x-fragment" id="fragmentShader">
#ifdef GL_ES
precision mediump float;
#endif

uniform vec2 u_resolution;
uniform vec2 u_mouse;
uniform float u_time;

float random (in vec2 st) {
    return fract(sin(dot(st.xy,
                         vec2(12.9898,78.233)))*
        43758.5453123);
}

// Based on Morgan McGuire @morgan3d
// https://www.shadertoy.com/view/4dS3Wd
float noise (in vec2 st) {
    vec2 i = floor(st);
    vec2 f = fract(st);

    // Four corners in 2D of a tile
    float a = random(i);
    float b = random(i + vec2(1.0, 0.0));
    float c = random(i + vec2(0.0, 1.0));
    float d = random(i + vec2(1.0, 1.0));

    vec2 u = f * f * (3.0 - 2.0 * f);

    return mix(a, b, u.x) +
            (c - a)* u.y * (1.0 - u.x) +
            (d - b) * u.x * u.y;
}

#define OCTAVES 6
float fbm (in vec2 st) {
    // Initial values
    float value = 0.0;
    float amplitude = .5;
    float frequency = 0.;
    //
    // Loop of octaves
    const mat2 m = mat2( 0.80,  0.60, -0.60,  0.80 );
    for (int i = 0; i < OCTAVES; i++) {
        value += amplitude * noise(st);
        st = m*st*2.;
        amplitude *= .5;
    }
    return value;
}

void main() {
    //vec2 st = gl_FragCoord.xy/u_resolution.y;
    vec2 st = (-u_resolution.xy+2.0*gl_FragCoord.xy)/u_resolution.y;
    //vec2 st = gl_FragCoord.xy/u_resolution.y*2.-1.;

    //st.x *= u_resolution.x/u_resolution.y;
    float dst = distance(st, (-u_resolution.xy+2.0*u_mouse)/u_resolution.y);

    vec3 color = vec3(0.0);
    vec2 q = vec2(1.0);
    vec2 r = vec2(1.0);
    vec2 m = vec2(1.0);
    vec2 n = vec2(1.0);
    q.x = fbm(st*3.0 + vec2(0.0, 0.0) );
    q.y =  fbm(st*3.0 + vec2(5.2, 1.3));

    r.x = fbm(st*3.0 + q*3.0 + vec2(0.730,.210) - u_time*0.058 );
    r.y = fbm(st*3.0 + q*3.0 + vec2(9.2, .8));

    // m.x = fbm(st*3.0 + r*3.0 + vec2(0.1730,.210) - u_time*0.00058);
    // m.y = fbm(st*3.0 + r*3.0 + vec2(0.30,.210) + u_time*0.002781);
    //
    // n.x = fbm(st*3.0 + m*3.0 + vec2(0.1730,.210) + u_time*0.0478);
    // n.y = fbm(st*3.0 + m*3.0 + vec2(0.30,.210) - u_time*0.0098);
    float f = fbm(st*3.0 + r*3.);

    color += fbm(st*3.0 + r*3.);
    color = mix(color, vec3(0.783, 0.1, 0.5), 0.5);
    //color = mix(color, vec3(0.783, 0.1, 0.5), 1.-dst);

    gl_FragColor = vec4((f*f*f+0.6*f*f+0.5*f)*color, 1.0);
}
</script>

<script type="x-shader/x-vertex" id="vertexShader">
  attribute vec3 position;
	attribute vec2 uv;
	uniform mat4 projectionMatrix;
	uniform mat4 modelViewMatrix;
	uniform mat3 normalMatrix;
	uniform float time;
	uniform vec2 mousePosition;
	varying vec2 vUv;
	varying float vElevation;

	varying float vDisplacement;

  float random (in vec2 st) {
      return fract(sin(dot(st.xy,
                           vec2(12.9898,78.233)))*
          43758.5453123);
  }

  void main() {
    vec3 posi = position + vec3( 0.0, 0.0,random(position.xy)*30.);
    gl_Position = projectionMatrix *
                  modelViewMatrix *
                  vec4(posi,1.0);
  }
</script>
